<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è©•åˆ†é é¢ï½œè·ä½ç•«åƒé©é…</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    h1, h2 { margin-bottom: 0.5rem; }
    .section { margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #ddd; }
    .section h3 { margin-top: 0; }
    .rating-row { margin: 1rem 0; }
    .rating-label { font-weight: bold; display: block; margin-bottom: 0.3rem; }
    .score-options input { margin-right: 0.3rem; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
  </style>
</head>
<body>
  <h1>ğŸ“ è·ä½ç•«åƒé©é…è©•åˆ†</h1>
  <div id="jobInfo" class="section"></div>
  <form id="scoreForm" class="section">
    <label for="userName"><strong>å¡«å¯«è€…å§“åï¼š</strong></label><br/>
    <input type="text" id="userName" name="userName" required style="width: 300px; padding: 0.5rem; margin-top: 0.5rem;"><br/><br/>
    <div id="questionArea"></div>
    <button type="submit">ğŸ“Š å®Œæˆè©•åˆ†ä¸¦ç”¢å‡ºé›·é”åœ–</button>
  </form>
  <div id="chartArea" style="margin-top: 3rem;"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const index = parseInt(params.get("index"), 10);
    const roles = JSON.parse(localStorage.getItem("roles") || "[]");
    const role = roles[index];

    if (!role) {
      document.body.innerHTML = "<p>æ‰¾ä¸åˆ°è·ä½è³‡æ–™ï¼Œè«‹å¾é¦–é é‡æ–°é¸æ“‡ã€‚</p>";
      throw new Error("No role data.");
    }

    document.getElementById("jobInfo").innerHTML = `
      <h2>${role.role}</h2>
      <p>${role.jobDescription}</p>
    `;

    const form = document.getElementById("scoreForm");
    const area = document.getElementById("questionArea");

    const allSections = [
      { label: "å­¸æ­·", key: "education", data: role.hardCriteria.education },
      { label: "ç¶“æ­·", key: "experience", data: role.hardCriteria.experience },
      { label: "å°ˆæ¥­æŠ€èƒ½", key: "skills", data: role.hardCriteria.skills },
      ...role.softSkills.map((s, i) => ({ label: `è»Ÿå¯¦åŠ›ï½œ${s.name}`, key: `soft${i}`, data: s })),
      ...role.personalityTraits.map((s, i) => ({ label: `äººæ ¼ç‰¹è³ªï½œ${s.name}`, key: `trait${i}`, data: s })),
      ...role.avoidTraits.map((s, i) => ({ label: `âš ï¸æ‡‰é¿å…ï½œ${s.name}`, key: `avoid${i}`, data: s }))
    ];

    allSections.forEach((section, i) => {
      const div = document.createElement("div");
      div.classList.add("section");
      div.innerHTML = `
        <h3>${section.label}</h3>
        <p>${section.data.description}</p>
        <div class="rating-row">
          <label class="rating-label">è«‹ç‚ºæ­¤é …ç›®è©•åˆ†ï¼š</label>
          <div class="score-options">
            ${[1,2,3,4,5].map(n => `
              <label><input type="radio" name="${section.key}" value="${n}" required> ${n}</label>
            `).join(" ")}
          </div>
        </div>
      `;
      area.appendChild(div);
    });

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const name = formData.get("userName").trim();
      const scores = allSections.map(s => parseInt(formData.get(s.key), 10));
      const labels = allSections.map(s => s.label);
      const avgScores = allSections.map(() => 3); // æ¨¡æ“¬å¹³å‡

      const ctx = document.createElement("canvas");
      document.getElementById("chartArea").innerHTML = "<h2>ğŸ“ˆ é©é…åº¦é›·é”åœ–</h2>";
      document.getElementById("chartArea").appendChild(ctx);

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels: labels,
          datasets: [
            {
              label: name,
              data: scores,
              borderWidth: 2,
              fill: true
            },
            {
              label: 'å¹³å‡æ¨™æº–ï¼ˆæ¨¡æ“¬ï¼‰',
              data: avgScores,
              borderWidth: 2,
              borderDash: [5,5],
              fill: false
            }
          ]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              min: 0,
              max: 5,
              ticks: { stepSize: 1 }
            }
          }
        }
      });

      // å„²å­˜è©•åˆ†è³‡æ–™
      const feedback = {
        name,
        role: role.role,
        index,
        scores,
        labels,
        submittedAt: new Date().toISOString()
      };
      const existing = JSON.parse(localStorage.getItem("feedbacks") || "[]");
      existing.push(feedback);
      localStorage.setItem("feedbacks", JSON.stringify(existing));
      alert("âœ… è©•åˆ†å·²å„²å­˜ï¼");
    });
  </script>
</body>
</html>
