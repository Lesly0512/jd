<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è©•åˆ†é é¢ï½œè·ä½ç•«åƒé©é…</title>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    h1, h2 { margin-bottom: 0.5rem; }
    .section { margin-bottom: 2rem; background: #fff; padding: 1rem; border-radius: 6px; border: 1px solid #ddd; }
    .section h3 { margin-top: 0; }
    .rating-row { margin: 1rem 0; }
    .rating-label { font-weight: bold; display: block; margin-bottom: 0.3rem; }
    .score-options input { margin-right: 0.3rem; }
    button { padding: 0.5rem 1rem; margin-top: 1rem; }
    .summary-box { margin-top: 2rem; background: #eef8ff; padding: 1rem; border-left: 4px solid #3399cc; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>ğŸ“ è·ä½ç•«åƒé©é…è©•åˆ†</h1>
  <div id="jobInfo" class="section"></div>
  <form id="scoreForm" class="section">
    <label for="userName"><strong>è¢«è©•äººå§“åï¼š</strong></label><br/>
    <input type="text" id="userName" name="userName" required style="width: 300px; padding: 0.5rem; margin-top: 0.5rem;"><br/><br/>
    <div id="questionArea"></div>
    <button type="submit">ğŸ“Š å®Œæˆè©•åˆ†ä¸¦ç”¢å‡ºé›·é”åœ–</button>
  </form>
  <div id="chartArea" style="margin-top: 3rem;"></div>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const params = new URLSearchParams(window.location.search);
    const index = parseInt(params.get("index"), 10);
    const roles = JSON.parse(localStorage.getItem("roles") || "[]");
    const role = roles[index];

    if (!role) {
      document.body.innerHTML = "<p>æ‰¾ä¸åˆ°è·ä½è³‡æ–™ï¼Œè«‹å¾é¦–é é‡æ–°é¸æ“‡ã€‚</p>";
      throw new Error("No role data.");
    }

    document.getElementById("jobInfo").innerHTML = `
      <h2>${role.role}</h2>
      <p>${role.jobDescription}</p>
    `;

    const form = document.getElementById("scoreForm");
    const area = document.getElementById("questionArea");

    const hard = [
      { label: "å­¸æ­·", key: "education", data: role.hardCriteria.education },
      { label: "ç¶“æ­·", key: "experience", data: role.hardCriteria.experience },
      { label: "å°ˆæ¥­æŠ€èƒ½", key: "skills", data: role.hardCriteria.skills }
    ];
    const soft = role.softSkills.map((s, i) => ({ label: `è»Ÿå¯¦åŠ›ï½œ${s.name}`, key: `soft${i}`, data: s }));
    const trait = role.personalityTraits.map((s, i) => ({ label: `äººæ ¼ç‰¹è³ªï½œ${s.name}`, key: `trait${i}`, data: s }));

    const allSections = [...hard, ...soft, ...trait];

    allSections.forEach(section => {
      const div = document.createElement("div");
      div.classList.add("section");
      div.innerHTML = `
        <h3>${section.label}</h3>
        <p>${section.data.description}</p>
        <div class="rating-row">
          <label class="rating-label">è«‹ç‚ºæ­¤é …ç›®è©•åˆ†ï¼š</label>
          <div class="score-options">
            ${[1,2,3,4,5].map(n => `
              <label><input type="radio" name="${section.key}" value="${n}" required> ${n}</label>
            `).join(" ")}
          </div>
        </div>
      `;
      area.appendChild(div);
    });

    form.addEventListener("submit", function(e) {
      e.preventDefault();
      const formData = new FormData(form);
      const name = formData.get("userName").trim();

      const scores = allSections.map(s => parseInt(formData.get(s.key), 10));
      const labels = allSections.map(s => s.label);
      const avgScores = allSections.map(() => 3); // æ¨¡æ“¬å¹³å‡

      const hardScores = scores.slice(0, hard.length);
      const softScores = scores.slice(hard.length, hard.length + soft.length);
      const traitScores = scores.slice(hard.length + soft.length);

      const avg = arr => arr.reduce((a, b) => a + b, 0) / arr.length;
      const totalScore = (
        avg(hardScores) * 0.4 +
        avg(softScores) * 0.3 +
        avg(traitScores) * 0.3
      ).toFixed(2);

      let level = "", summary = "";
      if (totalScore >= 4.5) {
        level = "é«˜åº¦åŒ¹é…";
        summary = "å®Œå…¨ç¬¦åˆç¡¬æŒ‡æ¨™ï¼ˆå­¸æ­·ã€ç¶“æ­·ã€æŠ€èƒ½ï¼‰è¦æ±‚ï¼Œä¸¦åœ¨é—œéµè»Ÿå¯¦åŠ›ä¸Šè¡¨ç¾å“è¶Šï¼Œå…·å‚™å“è¶Šçš„æ±ºç­–åŠ›ã€å‰µæ–°èƒ½åŠ›ã€åœ˜éšŠé ˜å°åŠ›ç­‰ï¼Œèƒ½ç«‹å³å‹ä»»è©²è·ä½ä¸¦ç‚ºä¼æ¥­å¸¶ä¾†åƒ¹å€¼ã€‚";
      } else if (totalScore >= 3.5) {
        level = "è‰¯å¥½åŒ¹é…";
        summary = "å¤§è‡´ç¬¦åˆç¡¬æŒ‡æ¨™è¦æ±‚ï¼Œåœ¨é—œéµè»Ÿå¯¦åŠ›æ–¹é¢å±•ç¾å¼·å¤§èƒ½åŠ›ï¼Œä½†å¯èƒ½åœ¨æŸäº›ç´°ç¯€ä¸Šç¨æœ‰ä¸è¶³ï¼Œä»èƒ½è¼ƒå¿«é©æ‡‰å´—ä½ã€‚";
      } else if (totalScore >= 2.5) {
        level = "éƒ¨åˆ†åŒ¹é…";
        summary = "éƒ¨åˆ†ç¬¦åˆç¡¬æŒ‡æ¨™ï¼Œä½†å¯èƒ½ç¼ºå°‘æŸäº›é—œéµç¶“é©—ã€æŠ€èƒ½ï¼Œæˆ–åœ¨è»Ÿå¯¦åŠ›æ–¹é¢éœ€è¦é€²ä¸€æ­¥åŸ¹é¤Šï¼Œèƒ½å¤ å‹ä»»ï¼Œä½†éœ€è¦ä¸€å®šæ™‚é–“é©æ‡‰èˆ‡å­¸ç¿’ã€‚";
      } else if (totalScore >= 1.5) {
        level = "ä½åº¦åŒ¹é…";
        summary = "å­¸æ­·ã€ç¶“æ­·ã€æŠ€èƒ½èˆ‡è·ä½éœ€æ±‚æœ‰é¡¯è‘—è½å·®ï¼Œæˆ–åœ¨è»Ÿå¯¦åŠ›è¡¨ç¾ä¸è¶³ï¼Œéœ€è¦å¤§é‡åŸ¹è¨“èˆ‡æŒ‡å°æ‰èƒ½å‹‰å¼·å‹ä»»ã€‚";
      } else {
        level = "å®Œå…¨ä¸åŒ¹é…";
        summary = "å­¸æ­·ã€ç¶“æ­·èˆ‡æŠ€èƒ½å‡åš´é‡ä¸ç¬¦ï¼Œè»Ÿå¯¦åŠ›ç„¡æ³•å±•ç¾é©æ‡‰æ€§ï¼Œç„¡æ³•æœ‰æ•ˆå‹ä»»è©²è·ä½ï¼Œä¸”åŸ¹é¤Šæˆæœ¬éé«˜ï¼Œå¹¾ä¹ç„¡é©ä»»å¯èƒ½ã€‚";
      }

      // å„²å­˜è³‡æ–™
      const feedback = {
        name,
        role: role.role,
        index,
        scores,
        labels,
        scoreTotal: totalScore,
        scoreLevel: level,
        submittedAt: new Date().toISOString()
      };
      const existing = JSON.parse(localStorage.getItem("feedbacks") || "[]");
      existing.push(feedback);
      localStorage.setItem("feedbacks", JSON.stringify(existing));

      // é¡¯ç¤ºåœ–è¡¨
      const ctx = document.createElement("canvas");
      document.getElementById("chartArea").innerHTML = "<h2>ğŸ“ˆ é©é…åº¦é›·é”åœ–</h2>";
      document.getElementById("chartArea").appendChild(ctx);

      new Chart(ctx, {
        type: 'radar',
        data: {
          labels,
          datasets: [
            { label: name, data: scores, borderWidth: 2, fill: true },
            { label: 'å¹³å‡æ¨™æº–ï¼ˆæ¨¡æ“¬ï¼‰', data: avgScores, borderWidth: 2, borderDash: [5, 5], fill: false }
          ]
        },
        options: {
          responsive: true,
          scales: {
            r: {
              min: 0,
              max: 5,
              ticks: { stepSize: 1 }
            }
          }
        }
      });

      const summaryDiv = document.createElement("div");
      summaryDiv.classList.add("summary-box");
      summaryDiv.innerHTML = `
        <h3>ğŸ” é©é…åº¦çµæœï¼š${level}ï¼ˆç¸½åˆ† ${totalScore}ï¼‰</h3>
        <p>${summary}</p>
      `;
      document.getElementById("chartArea").appendChild(summaryDiv);
    });
  </script>
</body>
</html>
