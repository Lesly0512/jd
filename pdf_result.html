<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>è©•åˆ†çµæœåŒ¯å‡º</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    h1, h2 { margin-bottom: 0.5rem; }
    .box { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    button { margin-top: 1rem; padding: 0.5rem 1rem; }
    .summary-box { margin-top: 2rem; background: #eef8ff; padding: 1rem; border-left: 4px solid #3399cc; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="box" id="pdfTarget">
    <h1>ğŸ“ˆ é©é…é›·é”åœ–</h1>
    <p id="meta"></p>
    <canvas id="chartCanvas" width="500" height="400"></canvas>
    <div class="summary-box" id="summaryBox"></div>
  </div>
  <button onclick="downloadPDF()">ğŸ“„ ä¸‹è¼‰ PDF</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const index = parseInt(params.get("feedback"), 10);
    const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
    const fb = feedbacks[index];

    if (!fb) {
      document.body.innerHTML = "<p>æ‰¾ä¸åˆ°è©•åˆ†è³‡æ–™ï¼Œè«‹é‡æ–°è¿”å›ã€‚</p>";
      throw new Error("Invalid feedback index");
    }

    document.getElementById("meta").innerText =
      `è¢«è©•äººå§“åï¼š${fb.name}ï½œè·ä½ï¼š${fb.role}ï½œæäº¤æ™‚é–“ï¼š${new Date(fb.submittedAt).toLocaleString("zh-TW")}`;

    const ctx = document.getElementById("chartCanvas").getContext("2d");
    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: fb.labels,
        datasets: [
          {
            label: fb.name,
            data: fb.scores,
            borderWidth: 2,
            fill: true
          },
          {
            label: 'å¹³å‡æ¨™æº–ï¼ˆæ¨¡æ“¬ï¼‰',
            data: fb.labels.map(() => 3),
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false
          }
        ]
      },
      options: {
        responsive: false,
        animation: false,
        scales: {
          r: {
            min: 0,
            max: 5,
            ticks: { stepSize: 1 }
          }
        }
      }
    });

    const total = parseFloat(fb.scoreTotal || "0").toFixed(2);
    const level = fb.scoreLevel || "";
    let summary = "";
    if (total >= 4.5) {
      summary = "å®Œå…¨ç¬¦åˆç¡¬æŒ‡æ¨™ï¼ˆå­¸æ­·ã€ç¶“æ­·ã€æŠ€èƒ½ï¼‰è¦æ±‚ï¼Œä¸¦åœ¨é—œéµè»Ÿå¯¦åŠ›ä¸Šè¡¨ç¾å“è¶Šï¼Œå…·å‚™å“è¶Šçš„æ±ºç­–åŠ›ã€å‰µæ–°èƒ½åŠ›ã€åœ˜éšŠé ˜å°åŠ›ç­‰ï¼Œèƒ½ç«‹å³å‹ä»»è©²è·ä½ä¸¦ç‚ºä¼æ¥­å¸¶ä¾†åƒ¹å€¼ã€‚";
    } else if (total >= 3.5) {
      summary = "å¤§è‡´ç¬¦åˆç¡¬æŒ‡æ¨™è¦æ±‚ï¼Œåœ¨é—œéµè»Ÿå¯¦åŠ›æ–¹é¢å±•ç¾å¼·å¤§èƒ½åŠ›ï¼Œä½†å¯èƒ½åœ¨æŸäº›ç´°ç¯€ä¸Šç¨æœ‰ä¸è¶³ï¼Œä»èƒ½è¼ƒå¿«é©æ‡‰å´—ä½ã€‚";
    } else if (total >= 2.5) {
      summary = "éƒ¨åˆ†ç¬¦åˆç¡¬æŒ‡æ¨™ï¼Œä½†å¯èƒ½ç¼ºå°‘æŸäº›é—œéµç¶“é©—ã€æŠ€èƒ½ï¼Œæˆ–åœ¨è»Ÿå¯¦åŠ›æ–¹é¢éœ€è¦é€²ä¸€æ­¥åŸ¹é¤Šï¼Œèƒ½å¤ å‹ä»»ï¼Œä½†éœ€è¦ä¸€å®šæ™‚é–“é©æ‡‰èˆ‡å­¸ç¿’ã€‚";
    } else if (total >= 1.5) {
      summary = "å­¸æ­·ã€ç¶“æ­·ã€æŠ€èƒ½èˆ‡è·ä½éœ€æ±‚æœ‰é¡¯è‘—è½å·®ï¼Œæˆ–åœ¨è»Ÿå¯¦åŠ›è¡¨ç¾ä¸è¶³ï¼Œéœ€è¦å¤§é‡åŸ¹è¨“èˆ‡æŒ‡å°æ‰èƒ½å‹‰å¼·å‹ä»»ã€‚";
    } else {
      summary = "å­¸æ­·ã€ç¶“æ­·èˆ‡æŠ€èƒ½å‡åš´é‡ä¸ç¬¦ï¼Œè»Ÿå¯¦åŠ›ç„¡æ³•å±•ç¾é©æ‡‰æ€§ï¼Œç„¡æ³•æœ‰æ•ˆå‹ä»»è©²è·ä½ï¼Œä¸”åŸ¹é¤Šæˆæœ¬éé«˜ï¼Œå¹¾ä¹ç„¡é©ä»»å¯èƒ½ã€‚";
    }

    document.getElementById("summaryBox").innerHTML = `
      <h3>ğŸ” é©é…åº¦çµæœï¼š${level}ï¼ˆç¸½åˆ† ${total}ï¼‰</h3>
      <p>${summary}</p>
    `;

    function downloadPDF() {
      const element = document.getElementById("pdfTarget");
      html2pdf().set({
        margin: 0.5,
        filename: `è©•åˆ†çµæœ_${fb.name}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).from(element).save();
    }
  </script>
</body>
</html>
