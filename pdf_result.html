<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <title>評分結果匯出</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 2rem; background: #f9f9f9; }
    h1, h2 { margin-bottom: 0.5rem; }
    .box { background: #fff; padding: 2rem; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.05); }
    button { margin-top: 1rem; padding: 0.5rem 1rem; }
  </style>
</head>
<body>
  <div class="box" id="pdfTarget">
    <h1>📈 適配雷達圖</h1>
    <p id="meta"></p>
    <canvas id="chartCanvas" width="500" height="400"></canvas>
  </div>
  <button onclick="downloadPDF()">📄 下載 PDF</button>

  <script>
    const params = new URLSearchParams(window.location.search);
    const index = parseInt(params.get("feedback"), 10);
    const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
    const fb = feedbacks[index];

    if (!fb) {
      document.body.innerHTML = "<p>找不到評分資料，請重新返回。</p>";
      throw new Error("Invalid feedback index");
    }

    document.getElementById("meta").innerText =
      `填寫者：${fb.name}｜職位：${fb.role}｜時間：${new Date(fb.submittedAt).toLocaleString("zh-TW")}`;

    const ctx = document.getElementById("chartCanvas").getContext("2d");
    new Chart(ctx, {
      type: 'radar',
      data: {
        labels: fb.labels,
        datasets: [
          {
            label: fb.name,
            data: fb.scores,
            borderWidth: 2,
            fill: true
          },
          {
            label: '平均標準（模擬）',
            data: fb.labels.map(() => 3),
            borderWidth: 2,
            borderDash: [5, 5],
            fill: false
          }
        ]
      },
      options: {
        responsive: false,
        animation: false,
        scales: {
          r: {
            min: 0,
            max: 5,
            ticks: { stepSize: 1 }
          }
        }
      }
    });

    function downloadPDF() {
      const element = document.getElementById("pdfTarget");
      html2pdf().set({
        margin: 0.5,
        filename: `評分結果_${fb.name}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
      }).from(element).save();
    }
  </script>
</body>
</html>
