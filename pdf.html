<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>é—œéµè·ä½ç•«åƒ</title>
  <style>
    body { font-family: "Noto Sans TC", sans-serif; padding: 2rem; line-height: 1.6; }
    h1, h2, h3 { margin-top: 1.5rem; }
    .section { margin-top: 1.5rem; }
    .score-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; }
    .score-table th, .score-table td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      vertical-align: top;
    }
    .meta { font-size: 0.9rem; color: #666; }
  </style>
</head>
<body>
  <h1>ğŸ“Œ é—œéµå´—ä½ç•«åƒ</h1>
  <p class="meta">åŒ¯å‡ºæ™‚é–“ï¼š<span id="timestamp"></span></p>

  <div id="roleContent"></div>
<script>
  const roleIndex = new URLSearchParams(window.location.search).get("index");
  const roles = JSON.parse(localStorage.getItem("roles") || "[]");
  const role = roles[roleIndex];

  if (!role) {
    document.getElementById("jobInfo").innerHTML = "<p>æŸ¥ç„¡è·ä½è³‡æ–™ã€‚</p>";
    document.getElementById("scoreForm").style.display = "none";
  } else {
    document.getElementById("jobInfo").innerHTML = `
      <h3>${role.role}</h3>
      <p>${role.description}</p>
    `;

    const container = document.getElementById("ratingSections");

    const buildBlock = (title, desc, scores, prefix) => {
      let html = `<div class="section-block"><h4>${title}</h4><p>${desc}</p><div class="rating-group">`;
      for (let i = 5; i >= 1; i--) {
        html += `
          <label>
            <input type="radio" name="${prefix}" value="${i}" required /> ${i}
          </label>
        `;
      }
      html += `</div><div><strong>ğŸ“˜ è©•åˆ†èªªæ˜ï¼š</strong><ul>`;
      scores.forEach(s => {
        html += `<li>${s}</li>`;
      });
      html += `</ul></div></div>`;
      return html;
    };

    // ç¡¬æŒ‡æ¨™
    container.innerHTML += buildBlock("ğŸ“ å­¸æ­·", role.hard.edu.desc, role.hard.edu.scores, "edu");
    container.innerHTML += buildBlock("ğŸ“‚ ç¶“æ­·", role.hard.exp.desc, role.hard.exp.scores, "exp");
    container.innerHTML += buildBlock("ğŸ› ï¸ å°ˆæ¥­æŠ€èƒ½", role.hard.skill.desc, role.hard.skill.scores, "skill");

    // è»Ÿå¯¦åŠ›
    role.soft.forEach((s, i) => {
      container.innerHTML += buildBlock(`ğŸŒŸ è»Ÿå¯¦åŠ›ï½œ${s.title}`, s.desc, s.scores, `soft${i}`);
    });

    // äººæ ¼ç‰¹è³ª
    role.trait.forEach((s, i) => {
      container.innerHTML += buildBlock(`ğŸ’¡ äººæ ¼ç‰¹è³ªï½œ${s.title}`, s.desc, s.scores, `trait${i}`);
    });
  }

  document.getElementById("scoreForm").addEventListener("submit", function (e) {
    e.preventDefault();
    const name = document.getElementById("personName").value.trim();
    if (!name) return alert("è«‹è¼¸å…¥è¢«è©•äººå§“å");

    const form = new FormData(this);
    const allScores = [];
    const weights = { hard: 0.4, soft: 0.3, trait: 0.3 };
    let sumHard = 0, sumSoft = 0, sumTrait = 0;
    let countHard = 3, countSoft = role.soft.length, countTrait = role.trait.length;

    for (let [key, val] of form.entries()) {
      const num = parseInt(val, 10);
      allScores.push(num);
      if (key.startsWith("edu") || key.startsWith("exp") || key.startsWith("skill")) sumHard += num;
      else if (key.startsWith("soft")) sumSoft += num;
      else if (key.startsWith("trait")) sumTrait += num;
    }

    const avgHard = sumHard / countHard;
    const avgSoft = countSoft ? sumSoft / countSoft : 0;
    const avgTrait = countTrait ? sumTrait / countTrait : 0;
    const totalScore = (
      avgHard * weights.hard +
      avgSoft * weights.soft +
      avgTrait * weights.trait
    );

    let level = "", explanation = "";
    if (totalScore >= 4.5) {
      level = "é«˜åº¦åŒ¹é…";
      explanation = "å®Œå…¨ç¬¦åˆç¡¬æŒ‡æ¨™è¦æ±‚ï¼Œä¸¦åœ¨é—œéµè»Ÿå¯¦åŠ›ä¸Šè¡¨ç¾å“è¶Šï¼Œèƒ½ç«‹å³å‹ä»»è©²è·ä½ä¸¦ç‚ºä¼æ¥­å¸¶ä¾†åƒ¹å€¼ã€‚";
    } else if (totalScore >= 3.5) {
      level = "è‰¯å¥½åŒ¹é…";
      explanation = "å¤§è‡´ç¬¦åˆç¡¬æŒ‡æ¨™è¦æ±‚ï¼Œåœ¨è»Ÿå¯¦åŠ›æ–¹é¢å±•ç¾å¼·å¤§èƒ½åŠ›ï¼Œä»èƒ½è¼ƒå¿«é©æ‡‰å´—ä½ã€‚";
    } else if (totalScore >= 2.5) {
      level = "éƒ¨åˆ†åŒ¹é…";
      explanation = "éƒ¨åˆ†ç¬¦åˆç¡¬æŒ‡æ¨™ï¼ŒæŸäº›è»Ÿå¯¦åŠ›éœ€åŸ¹é¤Šï¼Œèƒ½å‹ä»»ä½†éœ€æ™‚é–“é©æ‡‰èˆ‡å­¸ç¿’ã€‚";
    } else if (totalScore >= 1.5) {
      level = "ä½åº¦åŒ¹é…";
      explanation = "èˆ‡éœ€æ±‚æœ‰è½å·®ï¼Œéœ€å¤§é‡åŸ¹è¨“èˆ‡æŒ‡å°æ‰èƒ½å‹‰å¼·å‹ä»»ã€‚";
    } else {
      level = "å®Œå…¨ä¸åŒ¹é…";
      explanation = "èƒŒæ™¯èˆ‡èƒ½åŠ›çš†ä¸ç¬¦ï¼Œé›£ä»¥å‹ä»»è©²è·ä½ï¼ŒåŸ¹é¤Šæˆæœ¬éé«˜ã€‚";
    }

    const feedbacks = JSON.parse(localStorage.getItem("feedbacks") || "[]");
    feedbacks.push({
      name,
      role: role.role,
      scores: allScores,
      scoreTotal: totalScore.toFixed(2),
      scoreLevel: level,
      scoreExplanation: explanation,
      submittedAt: Date.now()
    });
    localStorage.setItem("feedbacks", JSON.stringify(feedbacks));
    alert("âœ… è©•åˆ†å®Œæˆï¼Œè³‡æ–™å·²å„²å­˜ï¼");
    location.href = "pdf_result.html?feedback=" + (feedbacks.length - 1);
  });
</script>
</body>
</html>
